<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
    <title>DocOps Agent | Document Intelligence</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=VT323&family=Outfit:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Dark theme with warm undertones - like old CRT monitors */
            --bg-darkest: #0a0c0f;
            --bg-primary: #12151a;
            --bg-secondary: #1a1e24;
            --bg-tertiary: #232830;
            --bg-elevated: #2d333d;

            /* Retro gaming accent - warm amber, like classic game UI */
            --accent-primary: #e8a935;
            --accent-muted: #c48a20;
            --accent-glow: rgba(232, 169, 53, 0.3);

            /* Status colors - slightly desaturated */
            --accent-success: #4ade80;
            --accent-warning: #fbbf24;
            --accent-danger: #f87171;
            --accent-info: #60a5fa;

            /* Text */
            --text-primary: #e4e4e7;
            --text-secondary: #a1a1aa;
            --text-muted: #71717a;

            /* Borders - chunky like retro UI */
            --border-subtle: rgba(255, 255, 255, 0.08);
            --border-default: rgba(255, 255, 255, 0.12);
            --border-accent: var(--accent-primary);

            /* Shadows */
            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.4);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.5);
            --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.6);
            --shadow-glow: 0 0 20px var(--accent-glow);

            /* Typography */
            --font-display: 'Outfit', sans-serif;
            --font-body: 'Outfit', sans-serif;
            --font-retro: 'VT323', monospace;  /* Pixel/retro font */

            /* Layout */
            --sidebar-width: 260px;
            --header-height: 64px;
            --radius-sm: 2px;      /* Squared off - retro feel */
            --radius-md: 4px;
            --radius-lg: 6px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-body);
            font-size: 15px;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
        }

        /* Subtle scanline effect - like old CRT */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: repeating-linear-gradient(
                0deg,
                transparent,
                transparent 2px,
                rgba(0, 0, 0, 0.03) 2px,
                rgba(0, 0, 0, 0.03) 4px
            );
            pointer-events: none;
            z-index: 9999;
        }

        /* Subtle grid background */
        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image:
                linear-gradient(rgba(255,255,255,0.015) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,255,255,0.015) 1px, transparent 1px);
            background-size: 32px 32px;
            pointer-events: none;
            z-index: -1;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: var(--bg-primary);
        }
        ::-webkit-scrollbar-thumb {
            background: var(--bg-elevated);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent-muted);
        }

        /* Layout */
        .app {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--bg-secondary);
            border-right: 3px solid var(--border-subtle);  /* Chunky border */
            padding: 0;
            display: flex;
            flex-direction: column;
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            z-index: 100;
        }

        .sidebar-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 3px solid var(--border-subtle);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            text-decoration: none;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-md);
        }

        .logo-icon img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .logo-text {
            font-family: var(--font-display);
            font-size: 1.15rem;
            font-weight: 600;
            color: var(--text-primary);
            letter-spacing: -0.02em;
        }

        .logo-text span {
            color: var(--accent-primary);
        }

        /* Navigation */
        .nav {
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.35rem;
            flex: 1;
            overflow-y: auto;
        }

        .nav-section {
            margin-bottom: 1.25rem;
        }

        .nav-section-title {
            font-family: var(--font-retro);
            font-size: 1rem;
            font-weight: 500;
            color: var(--accent-primary);
            padding: 0 0.75rem;
            margin-bottom: 0.5rem;
            letter-spacing: 0.05em;
        }

        .nav-item {
            padding: 0.65rem 0.9rem;
            border-radius: var(--radius-md);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.15s ease;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 0.9rem;
            font-weight: 500;
            border: 2px solid transparent;  /* Chunky border */
        }

        .nav-item:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border-color: var(--border-default);
        }

        .nav-item.active {
            background: rgba(232, 169, 53, 0.15);
            color: var(--accent-primary);
            border-color: var(--accent-primary);
            box-shadow: var(--shadow-glow);
        }

        .nav-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
        }

        .nav-badge {
            margin-left: auto;
            background: var(--accent-danger);
            color: white;
            font-family: var(--font-retro);
            font-size: 0.85rem;
            padding: 0.1rem 0.4rem;
            border: 2px solid rgba(255,255,255,0.2);
            min-width: 22px;
            text-align: center;
        }

        /* Main Content */
        .main {
            flex: 1;
            margin-left: var(--sidebar-width);
            min-height: 100vh;
            background: var(--bg-primary);
        }

        .main-header {
            height: var(--header-height);
            padding: 0 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 3px solid var(--border-subtle);
            background: rgba(18, 21, 26, 0.9);
            backdrop-filter: blur(8px);
            position: sticky;
            top: 0;
            z-index: 50;
        }

        .page-title {
            font-family: var(--font-retro);
            font-size: 1.4rem;
            font-weight: 500;
            color: var(--accent-primary);
            letter-spacing: 0.02em;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .content {
            padding: 1.75rem;
            max-width: 1400px;
        }

        /* Page */
        .page {
            display: none;
            animation: fadeIn 0.25s ease;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin-bottom: 1.75rem;
        }

        .stat-card {
            background: var(--bg-secondary);
            border: 3px solid var(--border-subtle);  /* Chunky border */
            border-radius: var(--radius-lg);
            padding: 1.25rem;
            transition: all 0.15s ease;
        }

        .stat-card:hover {
            border-color: var(--accent-primary);
            transform: translateY(-2px);
            box-shadow: var(--shadow-glow);
        }

        .stat-icon {
            width: 44px;
            height: 44px;
            border: 2px solid currentColor;
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            margin-bottom: 0.875rem;
        }

        .stat-icon.blue { color: var(--accent-info); }
        .stat-icon.green { color: var(--accent-success); }
        .stat-icon.yellow { color: var(--accent-warning); }
        .stat-icon.red { color: var(--accent-danger); }

        .stat-label {
            font-family: var(--font-retro);
            font-size: 1.1rem;
            color: var(--text-muted);
            margin-bottom: 0.25rem;
        }

        .stat-value {
            font-family: var(--font-display);
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        /* Cards */
        .card {
            background: var(--bg-secondary);
            border: 3px solid var(--border-subtle);
            border-radius: var(--radius-lg);
            overflow: hidden;
            margin-bottom: 1.5rem;
        }

        .card-header {
            padding: 1rem 1.25rem;
            border-bottom: 3px solid var(--border-subtle);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--bg-tertiary);
        }

        .card-title {
            font-family: var(--font-retro);
            font-size: 1.2rem;
            font-weight: 500;
            color: var(--accent-primary);
        }

        .card-body {
            padding: 1.25rem;
        }

        /* Buttons - chunky with press effect */
        .btn {
            padding: 0.6rem 1.25rem;
            border-radius: var(--radius-md);
            font-weight: 600;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.1s ease;
            border: 3px solid;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-family: var(--font-body);
        }

        .btn:active {
            transform: translateY(2px);
        }

        .btn-primary {
            background: var(--accent-primary);
            color: var(--bg-darkest);
            border-color: var(--accent-muted);
        }

        .btn-primary:hover {
            background: var(--accent-muted);
            box-shadow: var(--shadow-glow);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            border-color: var(--border-default);
        }

        .btn-secondary:hover {
            background: var(--bg-elevated);
            color: var(--text-primary);
            border-color: var(--text-muted);
        }

        .btn-success {
            background: var(--accent-success);
            color: var(--bg-darkest);
            border-color: #22c55e;
        }

        .btn-danger {
            background: var(--accent-danger);
            color: white;
            border-color: #dc2626;
        }

        .btn-sm {
            padding: 0.35rem 0.7rem;
            font-size: 0.8rem;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            font-family: var(--font-retro);
            font-size: 1.1rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .form-input {
            width: 100%;
            padding: 0.65rem 0.9rem;
            background: var(--bg-tertiary);
            border: 3px solid var(--border-default);
            border-radius: var(--radius-md);
            font-size: 0.9rem;
            color: var(--text-primary);
            transition: all 0.2s ease;
            font-family: var(--font-body);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: var(--shadow-glow);
        }

        .form-input::placeholder {
            color: var(--text-muted);
        }

        /* Range Slider - retro style */
        .range-container {
            padding: 0.5rem 0;
        }

        .range-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .range-value {
            font-family: var(--font-retro);
            font-weight: 600;
            color: var(--accent-primary);
            font-size: 1.1rem;
        }

        .form-range {
            width: 100%;
            height: 8px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-sm);
            border: 2px solid var(--border-default);
            -webkit-appearance: none;
            cursor: pointer;
        }

        .form-range::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            background: var(--accent-primary);
            border: 3px solid var(--accent-muted);
            border-radius: var(--radius-sm);  /* Square thumb */
            cursor: pointer;
            transition: all 0.1s ease;
        }

        .form-range::-webkit-slider-thumb:hover {
            transform: scale(1.1);
            box-shadow: var(--shadow-glow);
        }

        /* Upload Area */
        .upload-area {
            border: 3px dashed var(--border-default);
            border-radius: var(--radius-lg);
            padding: 3rem 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            background: var(--bg-tertiary);
        }

        .upload-area:hover {
            border-color: var(--accent-primary);
            background: rgba(232, 169, 53, 0.05);
            box-shadow: var(--shadow-glow);
        }

        .upload-area.dragover {
            border-color: var(--accent-primary);
            background: rgba(232, 169, 53, 0.1);
        }

        .upload-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            display: block;
        }

        .upload-text {
            color: var(--text-primary);
            font-size: 1.1rem;
            font-weight: 500;
            margin-bottom: 0.375rem;
        }

        .upload-hint {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .upload-formats {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
            margin-top: 1rem;
        }

        .format-tag {
            padding: 0.2rem 0.6rem;
            background: var(--bg-elevated);
            border: 2px solid var(--border-default);
            border-radius: var(--radius-sm);
            font-family: var(--font-retro);
            font-size: 0.95rem;
            color: var(--accent-primary);
        }

        /* Table */
        .table-container {
            overflow-x: auto;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th {
            padding: 0.75rem 1rem;
            text-align: left;
            font-family: var(--font-retro);
            font-size: 1rem;
            font-weight: 500;
            color: var(--accent-primary);
            background: var(--bg-tertiary);
            border-bottom: 3px solid var(--border-subtle);
        }

        .table td {
            padding: 0.875rem 1rem;
            font-size: 0.9rem;
            color: var(--text-secondary);
            border-bottom: 2px solid var(--border-subtle);
        }

        .table tr:hover td {
            background: rgba(232, 169, 53, 0.05);
        }

        /* Badges */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 0.15rem 0.5rem;
            border-radius: var(--radius-sm);
            font-family: var(--font-retro);
            font-size: 0.95rem;
            font-weight: 500;
            border: 2px solid currentColor;
        }

        .badge-success { background: rgba(74, 222, 128, 0.15); color: var(--accent-success); }
        .badge-warning { background: rgba(251, 191, 36, 0.15); color: var(--accent-warning); }
        .badge-danger { background: rgba(248, 113, 113, 0.15); color: var(--accent-danger); }
        .badge-info { background: rgba(96, 165, 250, 0.15); color: var(--accent-info); }
        .badge-purple { background: rgba(192, 132, 252, 0.15); color: #c084fc; }
        .badge-gray { background: var(--bg-tertiary); color: var(--text-muted); border-color: var(--border-default); }

        /* Loading */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2.5rem;
            color: var(--text-muted);
            gap: 0.75rem;
            font-family: var(--font-retro);
            font-size: 1.1rem;
        }

        .spinner {
            width: 18px;
            height: 18px;
            border: 3px solid var(--border-default);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 0.7s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem 2rem;
            color: var(--text-muted);
        }

        .empty-icon {
            font-size: 3rem;
            margin-bottom: 0.75rem;
            opacity: 0.4;
        }

        .empty-title {
            font-size: 1rem;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 0.375rem;
        }

        .empty-text {
            font-size: 0.85rem;
        }

        /* Progress */
        .progress-bar {
            height: 8px;
            background: var(--bg-tertiary);
            border: 2px solid var(--border-default);
            border-radius: var(--radius-sm);
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--accent-primary);
            transition: width 0.3s ease;
        }

        /* Alert */
        .alert {
            padding: 0.875rem 1rem;
            border-radius: var(--radius-md);
            margin-bottom: 1rem;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.625rem;
            border: 3px solid;
        }

        .alert-success { background: rgba(74, 222, 128, 0.1); border-color: var(--accent-success); color: var(--accent-success); }
        .alert-warning { background: rgba(251, 191, 36, 0.1); border-color: var(--accent-warning); color: var(--accent-warning); }
        .alert-danger { background: rgba(248, 113, 113, 0.1); border-color: var(--accent-danger); color: var(--accent-danger); }
        .alert-info { background: rgba(96, 165, 250, 0.1); border-color: var(--accent-info); color: var(--accent-info); }

        /* Search Box */
        .search-box {
            display: flex;
            align-items: center;
            background: var(--bg-tertiary);
            border: 3px solid var(--border-default);
            border-radius: var(--radius-md);
            padding: 0 0.75rem;
            gap: 0.5rem;
            transition: all 0.2s ease;
        }

        .search-box:focus-within {
            border-color: var(--accent-primary);
            box-shadow: var(--shadow-glow);
        }

        .search-box svg {
            color: var(--text-muted);
            flex-shrink: 0;
        }

        .search-input {
            background: transparent;
            border: none;
            outline: none;
            color: var(--text-primary);
            font-size: 0.875rem;
            padding: 0.5rem 0;
            width: 180px;
            font-family: var(--font-body);
        }

        .search-input::placeholder {
            color: var(--text-muted);
        }

        /* Document Selection Row */
        .doc-select-row {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            border-bottom: 2px solid var(--border-subtle);
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .doc-select-row:last-child {
            border-bottom: none;
        }

        .doc-select-row:hover {
            background: rgba(232, 169, 53, 0.08);
        }

        .doc-select-row.selected {
            background: rgba(232, 169, 53, 0.12);
            border-left: 4px solid var(--accent-primary);
        }

        .doc-select-icon {
            width: 40px;
            height: 40px;
            background: var(--accent-primary);
            border: 3px solid var(--accent-muted);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: var(--font-retro);
            font-weight: 600;
            color: var(--bg-darkest);
            font-size: 0.9rem;
            margin-right: 0.875rem;
        }

        .doc-select-info {
            flex: 1;
            min-width: 0;
        }

        .doc-select-name {
            font-weight: 500;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .doc-select-meta {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 0.125rem;
        }

        /* Extraction Grid */
        .extraction-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
        }

        .extraction-item {
            background: var(--bg-tertiary);
            padding: 0.875rem;
            border: 2px solid var(--border-subtle);
            border-radius: var(--radius-md);
        }

        .extraction-label {
            font-family: var(--font-retro);
            font-size: 1rem;
            color: var(--accent-primary);
            margin-bottom: 0.25rem;
        }

        .extraction-value {
            font-family: var(--font-display);
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        /* Line Items Table */
        .line-items-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            font-size: 0.85rem;
        }

        .line-items-table th {
            background: var(--bg-tertiary);
            padding: 0.5rem 0.75rem;
            text-align: left;
            font-family: var(--font-retro);
            font-size: 0.95rem;
            color: var(--accent-primary);
            border: 2px solid var(--border-subtle);
        }

        .line-items-table td {
            padding: 0.5rem 0.75rem;
            color: var(--text-secondary);
            border-bottom: 2px solid var(--border-subtle);
        }

        /* Anomaly List */
        .anomaly-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .anomaly-item {
            background: var(--bg-tertiary);
            border-left: 4px solid var(--accent-danger);
            border: 2px solid var(--border-subtle);
            padding: 0.75rem;
            border-radius: 0 var(--radius-md) var(--radius-md) 0;
        }

        .anomaly-type {
            font-family: var(--font-retro);
            font-size: 0.95rem;
            color: var(--accent-danger);
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .anomaly-message {
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        /* Approval Card */
        .approval-card {
            background: var(--bg-tertiary);
            border: 3px solid var(--border-subtle);
            border-radius: var(--radius-md);
            padding: 1rem;
            margin-bottom: 0.75rem;
            transition: all 0.15s ease;
        }

        .approval-card:hover {
            border-color: var(--accent-primary);
        }

        .approval-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.5rem;
        }

        .approval-type {
            font-weight: 600;
            color: var(--text-primary);
        }

        .approval-doc {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }

        .approval-actions {
            display: flex;
            gap: 0.5rem;
        }

        /* Settings */
        .settings-section {
            margin-bottom: 1.75rem;
        }

        .settings-title {
            font-family: var(--font-retro);
            font-size: 1.3rem;
            font-weight: 500;
            margin-bottom: 0.875rem;
            color: var(--accent-primary);
        }

        .settings-card {
            background: var(--bg-secondary);
            border: 3px solid var(--border-subtle);
            border-radius: var(--radius-lg);
            padding: 1.25rem;
        }

        /* Confidence Meter */
        .confidence-meter {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .confidence-bar {
            flex: 1;
            height: 10px;
            background: var(--bg-tertiary);
            border: 2px solid var(--border-default);
            border-radius: var(--radius-sm);
            overflow: hidden;
        }

        .confidence-fill {
            height: 100%;
            border-radius: var(--radius-sm);
            transition: width 0.3s ease;
        }

        .confidence-fill.high { background: var(--accent-success); }
        .confidence-fill.medium { background: var(--accent-warning); }
        .confidence-fill.low { background: var(--accent-danger); }

        .confidence-value {
            font-family: var(--font-retro);
            font-weight: 600;
            font-size: 1rem;
            min-width: 45px;
            text-align: right;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
        }

        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); }
            .main { margin-left: 0; }
            .stats-grid { grid-template-columns: 1fr; }
            .extraction-grid { grid-template-columns: 1fr; }
        }

        /* Utility */
        .text-center { text-align: center; }
        .mb-0 { margin-bottom: 0; }
        .mb-1 { margin-bottom: 0.5rem; }
        .mb-2 { margin-bottom: 1rem; }
        .mb-3 { margin-bottom: 1.5rem; }
        .mt-2 { margin-top: 1rem; }
        .mt-3 { margin-top: 1.5rem; }
        .flex { display: flex; }
        .flex-1 { flex: 1; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .gap-1 { gap: 0.5rem; }
        .gap-2 { gap: 1rem; }
    </style>
</head>
<body>
    <div class="app">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <a href="#" class="logo">
                    <img src="/static/docops-pet.svg" alt="DocOps" class="logo-icon" style="width: 40px; height: 40px; border: none;">
                    <div class="logo-text">Doc<span>Ops</span></div>
                </a>
            </div>
            <nav class="nav">
                <div class="nav-section">
                    <div class="nav-section-title">MAIN</div>
                    <div class="nav-item active" data-page="dashboard">
                        <span class="nav-icon">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="9"></rect><rect x="14" y="3" width="7" height="5"></rect><rect x="14" y="12" width="7" height="9"></rect><rect x="3" y="16" width="7" height="5"></rect></svg>
                        </span>
                        Dashboard
                    </div>
                    <div class="nav-item" data-page="upload">
                        <span class="nav-icon">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                        </span>
                        Upload Files
                    </div>
                    <div class="nav-item" data-page="documents">
                        <span class="nav-icon">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>
                        </span>
                        Documents
                    </div>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">INTELLIGENCE</div>
                    <div class="nav-item" data-page="analysis">
                        <span class="nav-icon">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg>
                        </span>
                        Analysis
                    </div>
                    <div class="nav-item" data-page="approvals">
                        <span class="nav-icon">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
                        </span>
                        Approvals
                        <span class="nav-badge" id="approval-badge" style="display: none;">0</span>
                    </div>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">SYSTEM</div>
                    <div class="nav-item" data-page="settings">
                        <span class="nav-icon">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                        </span>
                        Settings
                    </div>
                </div>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main">
            <header class="main-header">
                <h1 class="page-title" id="page-title">DASHBOARD</h1>
                <div class="header-actions">
                    <button class="btn btn-secondary btn-sm" onclick="refreshAll()">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"></polyline><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path></svg>
                        Refresh
                    </button>
                </div>
            </header>

            <div class="content">
                <!-- Dashboard Page -->
                <section id="dashboard-page" class="page active">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon blue">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>
                            </div>
                            <div class="stat-label">TOTAL DOCS</div>
                            <div class="stat-value" id="stat-total">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon green">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg>
                            </div>
                            <div class="stat-label">PROCESSED</div>
                            <div class="stat-value" id="stat-processed">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon yellow">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                            </div>
                            <div class="stat-label">PENDING</div>
                            <div class="stat-value" id="stat-pending">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon red">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
                            </div>
                            <div class="stat-label">ANOMALIES</div>
                            <div class="stat-value" id="stat-anomalies">0</div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">RECENT DOCUMENTS</h3>
                            <button class="btn btn-secondary btn-sm" onclick="showPage('documents')">View All</button>
                        </div>
                        <div class="card-body">
                            <div id="recent-docs">
                                <div class="loading">
                                    <div class="spinner"></div>
                                    Loading documents...
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Upload Page -->
                <section id="upload-page" class="page">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">UPLOAD DOCUMENTS</h3>
                        </div>
                        <div class="card-body">
                            <div class="upload-area" id="upload-dropzone">
                                <span class="upload-icon">
                                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                                </span>
                                <p class="upload-text">Drop your files here</p>
                                <p class="upload-hint">or click to browse your computer</p>
                                <div class="upload-formats">
                                    <span class="format-tag">PDF</span>
                                    <span class="format-tag">PNG</span>
                                    <span class="format-tag">JPG</span>
                                    <span class="format-tag">TIFF</span>
                                </div>
                                <input type="file" id="file-input" multiple accept=".pdf,.png,.jpg,.jpeg,.tiff,.bmp" style="display: none;">
                            </div>

                            <div id="upload-progress" style="display: none; margin-top: 1.5rem;">
                                <div class="card" style="background: var(--bg-tertiary); margin-bottom: 0;">
                                    <div class="card-body">
                                        <div class="flex items-center justify-between mb-1">
                                            <span id="upload-filename">Uploading...</span>
                                            <span id="upload-percent" style="color: var(--accent-primary); font-family: var(--font-retro); font-weight: 600;">0%</span>
                                        </div>
                                        <div class="progress-bar">
                                            <div class="progress-fill" id="upload-progress-fill" style="width: 0%"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div id="upload-result" style="display: none; margin-top: 1.5rem;"></div>
                        </div>
                    </div>
                </section>

                <!-- Documents Page -->
                <section id="documents-page" class="page">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">ALL DOCUMENTS</h3>
                            <button class="btn btn-primary btn-sm" onclick="refreshDocuments()">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"></polyline><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path></svg>
                                Refresh
                            </button>
                        </div>
                        <div class="card-body">
                            <div id="documents-list">
                                <div class="loading">
                                    <div class="spinner"></div>
                                    Loading documents...
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Analysis Page -->
                <section id="analysis-page" class="page">
                    <div class="card mb-3">
                        <div class="card-header">
                            <h3 class="card-title">PROCESSED DOCUMENTS</h3>
                            <div class="flex items-center gap-2">
                                <div class="search-box">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                                    <input type="text" class="search-input" id="analysis-search" placeholder="Search..." oninput="filterAnalysisDocs()">
                                </div>
                                <button class="btn btn-secondary btn-sm" onclick="loadAnalysisDocs()">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"></polyline><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path></svg>
                                </button>
                            </div>
                        </div>
                        <div class="card-body" style="padding: 0;">
                            <div id="analysis-docs-list" style="max-height: 280px; overflow-y: auto;">
                                <div class="loading">
                                    <div class="spinner"></div>
                                    Loading documents...
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="analysis-result" style="display: none;">
                        <div class="card mb-3">
                            <div class="card-header">
                                <h3 class="card-title">EXTRACTED DATA</h3>
                                <span class="badge badge-info" id="extraction-confidence">High</span>
                            </div>
                            <div class="card-body">
                                <div class="extraction-grid" id="extraction-data"></div>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">ANOMALIES DETECTED</h3>
                                <span class="badge badge-danger" id="anomaly-count">0</span>
                            </div>
                            <div class="card-body">
                                <div class="anomaly-list" id="anomalies-list"></div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Approvals Page -->
                <section id="approvals-page" class="page">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">PENDING APPROVALS</h3>
                        </div>
                        <div class="card-body">
                            <div id="approvals-list">
                                <div class="loading">
                                    <div class="spinner"></div>
                                    Loading approvals...
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Settings Page -->
                <section id="settings-page" class="page">
                    <div class="settings-section">
                        <h3 class="settings-title">PROCESSING SETTINGS</h3>
                        <div class="settings-card">
                            <div class="form-group mb-0">
                                <div class="range-container">
                                    <div class="range-header">
                                        <label class="form-label mb-0">Confidence Threshold</label>
                                        <span class="range-value" id="confidence-value">0.70</span>
                                    </div>
                                    <input type="range" class="form-range" id="confidence-slider" min="0" max="100" value="70" oninput="updateConfidenceDisplay()">
                                    <p style="font-size: 0.85rem; color: var(--text-muted); margin-top: 0.75rem;">
                                        Documents below this threshold need manual review.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="settings-section">
                        <h3 class="settings-title">SYSTEM STATUS</h3>
                        <div class="settings-card">
                            <div class="flex items-center gap-2">
                                <span class="badge badge-success">ONLINE</span>
                                <span style="color: var(--text-muted); font-size: 0.875rem;">API running on port 8002</span>
                            </div>
                        </div>
                    </div>

                    <div class="mt-3">
                        <button class="btn btn-primary" onclick="saveSettings()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
                            Save Settings
                        </button>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <script>
        const API_BASE = '/api/v1';

        const pageTitles = {
            'dashboard': 'DASHBOARD',
            'upload': 'UPLOAD FILES',
            'documents': 'ALL DOCUMENTS',
            'analysis': 'ANALYSIS',
            'approvals': 'APPROVALS',
            'settings': 'SETTINGS'
        };

        // Navigation
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', () => {
                const page = item.dataset.page;
                showPage(page);
            });
        });

        function showPage(pageId) {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.page === pageId) {
                    item.classList.add('active');
                }
            });

            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById(pageId + '-page').classList.add('active');
            document.getElementById('page-title').textContent = pageTitles[pageId];

            if (pageId === 'dashboard') loadDashboard();
            if (pageId === 'documents') loadDocuments();
            if (pageId === 'analysis') loadAnalysisDocs();
            if (pageId === 'approvals') loadApprovals();
            if (pageId === 'settings') loadSettings();
        }

        // API Helper
        async function apiCall(endpoint, options = {}) {
            const response = await fetch(API_BASE + endpoint, {
                ...options,
                headers: {
                    'Content-Type': 'application/json',
                    ...options.headers
                }
            });
            if (!response.ok) {
                const error = await response.json().catch(() => ({ detail: 'Request failed' }));
                throw new Error(error.detail || 'Request failed');
            }
            // Handle 204 No Content (empty response)
            if (response.status === 204) {
                return null;
            }
            return response.json();
        }

        // Dashboard
        async function loadDashboard() {
            try {
                const docs = await apiCall('/documents?page_size=500');
                const approvals = await apiCall('/approvals').catch(() => ({ approvals: [] }));

                const total = docs.total || docs.documents?.length || 0;
                const processed = docs.documents?.filter(d => d.status === 'processed').length || 0;
                const pending = approvals.approvals?.filter(a => a.status === 'pending').length || 0;

                document.getElementById('stat-total').textContent = total;
                document.getElementById('stat-processed').textContent = processed;
                document.getElementById('stat-pending').textContent = pending;

                const badge = document.getElementById('approval-badge');
                if (pending > 0) {
                    badge.textContent = pending;
                    badge.style.display = 'block';
                } else {
                    badge.style.display = 'none';
                }

                const recentContainer = document.getElementById('recent-docs');
                if (docs.documents?.length > 0) {
                    const recentDocs = docs.documents.slice(0, 5);
                    recentContainer.innerHTML = `
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr><th>FILENAME</th><th>STATUS</th><th>TYPE</th><th>DATE</th></tr>
                                </thead>
                                <tbody>
                                    ${recentDocs.map(doc => `
                                        <tr>
                                            <td style="color: var(--text-primary); font-weight: 500;">${doc.filename}</td>
                                            <td>${getStatusBadge(doc.status)}</td>
                                            <td>${doc.document_type || '-'}</td>
                                            <td>${formatDate(doc.uploaded_at)}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                } else {
                    recentContainer.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">
                                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>
                            </div>
                            <p class="empty-title">No documents yet</p>
                            <p class="empty-text">Upload your first document to get started</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Dashboard error:', error);
            }
        }

        // Upload
        const uploadDropzone = document.getElementById('upload-dropzone');
        const fileInput = document.getElementById('file-input');

        uploadDropzone.addEventListener('click', () => fileInput.click());
        uploadDropzone.addEventListener('dragover', (e) => { e.preventDefault(); uploadDropzone.classList.add('dragover'); });
        uploadDropzone.addEventListener('dragleave', () => uploadDropzone.classList.remove('dragover'));
        uploadDropzone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadDropzone.classList.remove('dragover');
            if (e.dataTransfer.files.length > 0) handleUpload(e.dataTransfer.files);
        });
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) handleUpload(e.target.files);
        });

        async function handleUpload(files) {
            const progressDiv = document.getElementById('upload-progress');
            const resultDiv = document.getElementById('upload-result');
            const progressFill = document.getElementById('upload-progress-fill');
            const percentSpan = document.getElementById('upload-percent');
            const filenameSpan = document.getElementById('upload-filename');

            progressDiv.style.display = 'block';
            resultDiv.style.display = 'none';

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                filenameSpan.textContent = file.name;
                progressFill.style.width = '0%';
                percentSpan.textContent = '0%';

                const formData = new FormData();
                formData.append('files', file);

                try {
                    const xhr = new XMLHttpRequest();
                    xhr.upload.addEventListener('progress', (e) => {
                        if (e.lengthComputable) {
                            const percent = Math.round((e.loaded / e.total) * 100);
                            progressFill.style.width = percent + '%';
                            percentSpan.textContent = percent + '%';
                        }
                    });

                    await new Promise((resolve, reject) => {
                        xhr.onload = () => xhr.status >= 200 && xhr.status < 300 ? resolve() : reject(new Error('Upload failed'));
                        xhr.onerror = () => reject(new Error('Upload failed'));
                        xhr.open('POST', API_BASE + '/documents/upload');
                        xhr.send(formData);
                    });

                    progressFill.style.width = '100%';
                    percentSpan.textContent = '100%';
                } catch (error) {
                    resultDiv.innerHTML = `<div class="alert alert-danger">Upload failed: ${error.message}</div>`;
                    resultDiv.style.display = 'block';
                    return;
                }
            }

            resultDiv.innerHTML = `<div class="alert alert-success"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg> Successfully uploaded ${files.length} document(s)</div>`;
            resultDiv.style.display = 'block';
            loadDashboard();
        }

        // Documents
        async function loadDocuments() {
            const container = document.getElementById('documents-list');
            container.innerHTML = '<div class="loading"><div class="spinner"></div>Loading...</div>';

            try {
                const response = await apiCall('/documents?page_size=500');
                const docs = response.documents || [];

                if (docs.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">
                                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>
                            </div>
                            <p class="empty-title">No documents</p>
                            <p class="empty-text">Upload documents to see them here</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = `
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr><th>FILENAME</th><th>STATUS</th><th>TYPE</th><th>SIZE</th><th>DATE</th><th>ACTIONS</th></tr>
                            </thead>
                            <tbody>
                                ${docs.map(doc => `
                                    <tr>
                                        <td style="color: var(--text-primary); font-weight: 500;">${doc.filename}</td>
                                        <td>${getStatusBadge(doc.status)}</td>
                                        <td>${doc.document_type || '-'}</td>
                                        <td>${formatBytes(doc.size_bytes)}</td>
                                        <td>${formatDate(doc.uploaded_at)}</td>
                                        <td>
                                            <div class="flex gap-1">
                                                ${doc.status === 'uploaded' ? `<button class="btn btn-primary btn-sm" onclick="processDocument('${doc.id}')">Process</button>` : ''}
                                                <button class="btn btn-danger btn-sm" onclick="deleteDocument('${doc.id}')">Delete</button>
                                            </div>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            } catch (error) {
                container.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
            }
        }

        async function refreshDocuments() { await loadDocuments(); }

        async function processDocument(id) {
            try {
                await apiCall(`/documents/${id}/process`, { method: 'POST' });

                // Poll for status updates until processing is complete
                const maxAttempts = 60; // 60 seconds max
                let attempts = 0;

                const pollStatus = async () => {
                    if (attempts >= maxAttempts) {
                        console.log('Polling timed out');
                        await loadDocuments();
                        return;
                    }

                    attempts++;
                    try {
                        const response = await apiCall(`/documents/${id}/status`);
                        const status = response.status;

                        // Update the UI with current status
                        await loadDocuments();

                        // Continue polling if still processing
                        if (status === 'ingesting' || status === 'extracting' || status === 'analyzing') {
                            setTimeout(pollStatus, 1000);
                        } else if (status === 'processed') {
                            console.log('Processing complete');
                        } else if (status === 'failed') {
                            console.log('Processing failed');
                        }
                    } catch (e) {
                        console.error('Status check failed:', e);
                        setTimeout(pollStatus, 2000);
                    }
                };

                // Start polling
                setTimeout(pollStatus, 500);

            } catch (error) {
                alert('Processing failed: ' + error.message);
            }
        }

        async function deleteDocument(id) {
            if (!confirm('Are you sure you want to delete this document?')) return;
            try {
                await apiCall(`/documents/${id}`, { method: 'DELETE' });
                await loadDocuments();
            } catch (error) {
                alert('Delete failed: ' + error.message);
            }
        }

        // Analysis
        let analysisDocsCache = [];

        async function loadAnalysisDocs() {
            const container = document.getElementById('analysis-docs-list');
            container.innerHTML = '<div class="loading"><div class="spinner"></div>Loading...</div>';

            try {
                const response = await apiCall('/documents?page_size=500');
                const docs = response.documents || [];
                analysisDocsCache = docs.filter(d => d.status === 'processed');
                renderAnalysisDocs(analysisDocsCache);
            } catch (error) {
                container.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
            }
        }

        function renderAnalysisDocs(docs) {
            const container = document.getElementById('analysis-docs-list');

            if (docs.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
                        </div>
                        <p class="empty-title">No processed documents</p>
                        <p class="empty-text">Process some documents first to see them here</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = docs.map(doc => {
                const hasExtraction = doc.extraction && doc.extraction.data;
                const ext = doc.extraction || {};
                const confLevel = ext.confidence_level || (ext.confidence > 0.7 ? 'high' : ext.confidence > 0.4 ? 'medium' : 'low');

                return `
                    <div class="doc-select-row" onclick="selectAnalysisDoc('${doc.id}')" data-doc-id="${doc.id}">
                        <div class="doc-select-icon">PDF</div>
                        <div class="doc-select-info">
                            <div class="doc-select-name">${doc.filename}</div>
                            <div class="doc-select-meta">
                                ${hasExtraction ? `Vendor: ${ext.data.vendor_name || 'N/A'} | Total: $${ext.data.total || '0.00'}` : 'No extraction data'}
                            </div>
                        </div>
                        ${hasExtraction ? `<span class="badge badge-${confLevel === 'high' ? 'success' : confLevel === 'medium' ? 'warning' : 'danger'}">${confLevel.toUpperCase()}</span>` : ''}
                    </div>
                `;
            }).join('');
        }

        function filterAnalysisDocs() {
            const searchTerm = document.getElementById('analysis-search').value.toLowerCase();
            const filtered = analysisDocsCache.filter(doc => {
                const filename = doc.filename.toLowerCase();
                const vendor = (doc.extraction?.data?.vendor_name || '').toLowerCase();
                const invoice = (doc.extraction?.data?.invoice_number || '').toLowerCase();
                return filename.includes(searchTerm) || vendor.includes(searchTerm) || invoice.includes(searchTerm);
            });
            renderAnalysisDocs(filtered);
        }

        async function selectAnalysisDoc(docId) {
            document.querySelectorAll('.doc-select-row').forEach(row => {
                row.classList.remove('selected');
                if (row.dataset.docId === docId) row.classList.add('selected');
            });

            const resultDiv = document.getElementById('analysis-result');
            resultDiv.style.display = 'block';

            try {
                const doc = await apiCall(`/documents/${docId}`);
                const extraction = doc.extraction;

                const confBadge = document.getElementById('extraction-confidence');
                if (extraction) {
                    const level = extraction.confidence_level || (extraction.confidence > 0.7 ? 'high' : 'medium');
                    confBadge.textContent = level.toUpperCase();
                    confBadge.className = 'badge badge-' + (level === 'high' ? 'success' : level === 'medium' ? 'warning' : 'danger');
                }

                const dataDiv = document.getElementById('extraction-data');
                if (extraction && extraction.data) {
                    const data = extraction.data;
                    dataDiv.innerHTML = `
                        <div class="extraction-item">
                            <div class="extraction-label">VENDOR</div>
                            <div class="extraction-value">${data.vendor_name || '-'}</div>
                        </div>
                        <div class="extraction-item">
                            <div class="extraction-label">INVOICE #</div>
                            <div class="extraction-value">${data.invoice_number || '-'}</div>
                        </div>
                        <div class="extraction-item">
                            <div class="extraction-label">DATE</div>
                            <div class="extraction-value">${data.date || '-'}</div>
                        </div>
                        <div class="extraction-item">
                            <div class="extraction-label">TOTAL</div>
                            <div class="extraction-value">$${data.total || '0.00'}</div>
                        </div>
                        <div class="extraction-item">
                            <div class="extraction-label">SUBTOTAL</div>
                            <div class="extraction-value">$${data.subtotal || '0.00'}</div>
                        </div>
                        <div class="extraction-item">
                            <div class="extraction-label">TAX</div>
                            <div class="extraction-value">$${data.tax || '0.00'}</div>
                        </div>
                        <div class="extraction-item" style="grid-column: span 2;">
                            <div class="extraction-label">CONFIDENCE SCORE</div>
                            <div class="confidence-meter">
                                <div class="confidence-bar"><div class="confidence-fill ${extraction.confidence > 0.7 ? 'high' : extraction.confidence > 0.4 ? 'medium' : 'low'}" style="width: ${(extraction.confidence || 0) * 100}%"></div></div>
                                <span class="confidence-value">${Math.round((extraction.confidence || 0) * 100)}%</span>
                            </div>
                        </div>
                    `;

                    if (data.line_items && data.line_items.length > 0) {
                        dataDiv.innerHTML += `
                            <div style="grid-column: span 2; margin-top: 0.5rem;">
                                <div class="extraction-label" style="margin-bottom: 0.5rem;">LINE ITEMS (${data.line_items.length})</div>
                                <table class="line-items-table">
                                    <thead><tr><th>DESCRIPTION</th><th>QTY</th><th>UNIT PRICE</th><th>TOTAL</th></tr></thead>
                                    <tbody>
                                        ${data.line_items.map(item => `
                                            <tr>
                                                <td style="color: var(--text-primary);">${item.description || '-'}</td>
                                                <td>${item.quantity || '-'}</td>
                                                <td>$${item.unit_price || '0.00'}</td>
                                                <td style="color: var(--text-primary); font-weight: 500;">$${item.total || '0.00'}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        `;
                    }
                } else {
                    dataDiv.innerHTML = '<div class="empty-state"><p>No extraction data available</p></div>';
                }

                const anomaliesList = document.getElementById('anomalies-list');
                const anomalyCount = document.getElementById('anomaly-count');

                // Fetch analysis to get anomalies
                try {
                    const analysis = await apiCall(`/analysis/document/${docId}`);
                    if (analysis && analysis.anomalies && analysis.anomalies.length > 0) {
                        anomaliesList.innerHTML = analysis.anomalies.map(a => `
                            <div class="anomaly-item">
                                <div class="anomaly-type">${a.anomaly_type.toUpperCase()}</div>
                                <div class="anomaly-message">${a.description}</div>
                                <div class="anomaly-message" style="margin-top: 0.25rem; font-size: 0.75rem;">
                                    ${a.recommendation || ''}
                                </div>
                            </div>
                        `).join('');
                        anomalyCount.textContent = analysis.anomalies.length;
                    } else {
                        anomaliesList.innerHTML = '<div class="empty-state"><p>No anomalies detected</p></div>';
                        anomalyCount.textContent = '0';
                    }
                } catch (e) {
                    console.error('Error fetching analysis:', e);
                    anomaliesList.innerHTML = '<div class="empty-state"><p>No anomalies detected</p></div>';
                    anomalyCount.textContent = '0';
                }
            } catch (error) {
                console.error('Analysis error:', error);
            }
        }

        // Approvals
        async function loadApprovals() {
            const container = document.getElementById('approvals-list');
            container.innerHTML = '<div class="loading"><div class="spinner"></div>Loading...</div>';

            try {
                const response = await apiCall('/approvals');
                const approvals = response.approvals || [];

                if (approvals.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">
                                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
                            </div>
                            <p class="empty-title">No pending approvals</p>
                            <p class="empty-text">All caught up!</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = approvals.map(approval => `
                    <div class="approval-card">
                        <div class="approval-header">
                            <div>
                                <div class="approval-type">${approval.request_type || 'Review'}</div>
                                <div class="approval-doc">Document ID: ${approval.document_id}</div>
                            </div>
                            <div class="approval-actions">
                                <button class="btn btn-success btn-sm" onclick="approveRequest('${approval.id}')">Approve</button>
                                <button class="btn btn-danger btn-sm" onclick="rejectRequest('${approval.id}')">Reject</button>
                            </div>
                        </div>
                        ${approval.context ? `<p style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.5rem;">${JSON.stringify(approval.context)}</p>` : ''}
                    </div>
                `).join('');
            } catch (error) {
                container.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
            }
        }

        async function approveRequest(id) {
            try {
                await apiCall(`/approvals/${id}/respond`, { method: 'POST', body: JSON.stringify({ status: 'approved' }) });
                await loadApprovals();
            } catch (error) { alert('Failed: ' + error.message); }
        }

        async function rejectRequest(id) {
            try {
                await apiCall(`/approvals/${id}/respond`, { method: 'POST', body: JSON.stringify({ status: 'rejected' }) });
                await loadApprovals();
            } catch (error) { alert('Failed: ' + error.message); }
        }

        // Settings
        async function loadSettings() {
            try {
                const response = await fetch('/docops_settings.json');
                const settings = await response.json();
                const slider = document.getElementById('confidence-slider');
                const valueSpan = document.getElementById('confidence-value');
                slider.value = (settings.confidence_threshold || 0.7) * 100;
                valueSpan.textContent = (settings.confidence_threshold || 0.7).toFixed(2);
            } catch (error) { console.error('Settings error:', error); }
        }

        function updateConfidenceDisplay() {
            const slider = document.getElementById('confidence-slider');
            const valueSpan = document.getElementById('confidence-value');
            valueSpan.textContent = (slider.value / 100).toFixed(2);
        }

        async function saveSettings() {
            const slider = document.getElementById('confidence-slider');
            const threshold = slider.value / 100;

            try {
                await fetch('/docops_settings.json', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ confidence_threshold: threshold, max_concurrent_jobs: 3 })
                });
                alert('Settings saved successfully');
            } catch (error) { alert('Failed to save settings: ' + error.message); }
        }

        // Utility
        function getStatusBadge(status) {
            const badges = {
                'uploaded': 'badge-info',
                'ingesting': 'badge-warning',
                'extracting': 'badge-warning',
                'analyzing': 'badge-warning',
                'awaiting_approval': 'badge-purple',
                'processed': 'badge-success',
                'failed': 'badge-danger'
            };
            return `<span class="badge ${badges[status] || 'badge-gray'}">${status.toUpperCase()}</span>`;
        }

        function formatDate(dateStr) {
            if (!dateStr) return '-';
            return new Date(dateStr).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        function formatBytes(bytes) {
            if (!bytes) return '-';
            const sizes = ['B', 'KB', 'MB'];
            const i = Math.floor(Math.log(bytes) / Math.log(1024));
            return Math.round(bytes / Math.pow(1024, i) * 100) / 100 + ' ' + sizes[i];
        }

        async function refreshAll() {
            const currentPage = document.querySelector('.nav-item.active').dataset.page;
            showPage(currentPage);
        }

        document.addEventListener('DOMContentLoaded', () => { loadDashboard(); });
    </script>
</body>
</html>
